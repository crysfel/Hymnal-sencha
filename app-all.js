/*
Copyright(c) 2011 Company Name
*/
Ext.define("Hymnal.controller.Home",{extend:"Ext.app.Controller",models:["Hymn"],stores:["Hymns","Categories"],views:["HymnsList","Home","Categories"],config:{refs:{home:{xtype:"home",selector:"home",autoCreate:true},back:{selector:"home hymnslist button[action=back]"},result:{selector:"home hymnslist list"},hymn:{selector:"home hymnslist #hymn"},title:{selector:"hymnslist toolbar title"},searchbar:{selector:"home hymnslist #searchbar"}}},init:function(){var a=this;a.control({"hymnslist toolbar[docked=top] button[action=search]":{tap:a.toggleSearchBar},"hymnslist list":{select:a.showHymn},"hymnslist toolbar[docked=top] button[action=back]":{tap:a.showResult},"hymnslist toolbar[docked=top] textfield":{action:a.search,blur:a.blurSearch}});a.startApp()},startApp:function(){var a=this,b=a.getHome();Ext.Viewport.add(b)},toggleSearchBar:function(a,c){var b=this.getSearchbar();if(b.isHidden()){b.show()}else{b.hide()}},showHymn:function(b,a){this.getTitle().setTitle("Himno #"+a.get("id"));this.getHymn().setData(a.data);this.getResult().hide();this.getHymn().show();this.getBack().show();this.getSearchbar().hide()},showResult:function(){this.getTitle().setTitle("Índice por títulos");this.getResult().show();this.getHymn().hide();this.getBack().hide()},loadData:function(){},search:function(e,d){var c=this,b=[],a=c.getResult().getStore();words=e.getValue().split(" ");Ext.each(words,function(g){var f=new RegExp(g,"i");b.push({property:"titlePlain",value:f})});a.clearFilter();a.filter(b);e.blur()},clearSearch:function(a){this.getResult().getStore().clearFilter()},blurSearch:function(a){if(a.getValue()===""){this.clearSearch()}}});Ext.define("Hymnal.view.Categories",{extend:"Ext.Panel",alias:"widget.categories",config:{items:[{xtype:"toolbar",docked:"top",title:"Índice por temas"},{xtype:"list",itemTpl:"<p>{name}</p>",store:"Hymnal.store.Categories"}]}});Ext.define("Hymnal.model.Hymn",{extend:"Ext.data.Model",config:{fields:["id","title",{name:"titlePlain",mapping:"title_plain"},"preview","content","musicImage"]}});Ext.define("Hymnal.view.Home",{extend:"Ext.tab.Panel",alias:"widget.home",config:{tabBar:{layout:{pack:"center",align:"center"},docked:"bottom"},items:[{title:"Indice",layout:"fit",items:[{xtype:"hymnslist"}],iconCls:"search"},{title:"Temas",items:{xtype:"categories"},iconCls:"bookmarks"},{title:"Mas",html:"Config",iconCls:"more"}]}});Ext.define("Hymnal.store.Hymns",{extend:"Ext.data.Store",alias:"store.hymns",config:{model:"Hymnal.model.Hymn",sorters:"titlePlain",autoLoad:true,proxy:{type:"ajax",url:Hymnal.BASE_PATH+"index.php/hymnal/findAll",reader:{type:"json",rootProperty:"data"}},grouper:{groupFn:function(a){return a.get("titlePlain")[0]}}}});Ext.define("Hymnal.view.HymnsList",{extend:"Ext.Panel",alias:"widget.hymnslist",config:{layout:"card",items:[{docked:"top",xtype:"toolbar",items:[{text:"Volver",ui:"back",action:"back",hidden:true},{xtype:"spacer"},{xtype:"title",title:"Índice por títulos"},{xtype:"spacer"},{iconMask:true,iconCls:"search",action:"search",clearIcon:true}]},{xtype:"toolbar",docked:"top",hidden:true,itemId:"searchbar",items:[{xtype:"searchfield",flex:1,height:27,placeHolder:"Búsque por palabras o número"},{xtype:"button",text:"Cancelar"}]},{xtype:"list",itemTpl:'<h2 class="hymn-title">{title}</h2><p class="hymn-description">{id} {preview}...</p>',grouped:true,indexBar:{docked:"right",overlay:true,alphabet:true},store:{type:"hymns"}},{cls:"hymn-content",itemId:"hymn",scrollable:"vertical",tpl:["<h3>{title}</h3><p>{content}</p>"]}]}});Ext.define("Hymnal.store.Categories",{extend:"Ext.data.Store",config:{model:"Hymnal.model.Hymn",proxy:{type:"ajax",url:Hymnal.BASE_PATH+"index.php/hymnal/findCategories",reader:{type:"json",rootProperty:"data"}}}});Ext.Loader.setConfig({enabled:true,disableCaching:true});Ext.application({name:"Hymnal",appFolder:Hymnal.BASE_PATH+"js/Hymnal",controllers:["Home"],launch:function(){window[this.name].App=this}});
